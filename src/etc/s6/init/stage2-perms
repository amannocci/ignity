#!/bin/execlineb -S0

importas -D root USER USER
importas -D 0 USERMAP_UID USERMAP_UID
importas -D 0 USERMAP_GID USERMAP_GID

# This env decides if we should call s6-sync or not (default no)
importas -D 0 IGNITY_SKIP_PERMS IGNITY_SKIP_PERMS

foreground {
  if -n { redirfd -c 2 /dev/null redirfd -c 1 /dev/null id -u "${USER}" }
  if { groupadd -g "${USERMAP_GID}" "${USER}" }
  if { useradd -M -u "${USERMAP_UID}" -g "${USERMAP_GID}" -s /bin/false "${USER}" }
}

ifelse {
  s6-test ${IGNITY_SKIP_PERMS} -eq 1
} {
  $@
}

if {
  if -t { s6-test -d /etc/ignity/perms }
  if { s6-echo -- "[ignity/perm] Applying ownership & permissions fixes" }
  if {
    pipeline { s6-ls -0 -- /etc/ignity/perms }
    pipeline { s6-sort -0 -- }
    forstdin -0 -- i
    importas -u i i
    if { s6-echo -- "[ignity/perm] Applying ownership & permission fixes: ${i}... " }
    foreground { redirfd -r 0 /etc/ignity/perms/${i} fix-perms }
    importas -u ? ?
    if { s6-echo -- "[ignity/perm] Ownership & permission fixes ${i} exited ${?}." }
    exit ${?}
  }
  if { s6-echo -- "[ignity/perm] Ownership & permissions fixes applied" }
}

$@